<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QuizEarn â€” Login / Register</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--accent:#4f46e5;--bg:#f8fafc;--card:#ffffff;--muted:#6b7280}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:linear-gradient(180deg,#eef2ff, #f8fafc);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
  .card{width:100%;max-width:420px;background:var(--card);border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.08);padding:20px}
  h1{margin:0 0 8px;font-size:20px}
  p.lead{margin:0 0 18px;color:var(--muted);font-size:14px}
  .row{display:flex;gap:8px}
  input{width:100%;padding:12px;border-radius:8px;border:1px solid #e6e9ef;outline:none;font-size:14px}
  button{background:var(--accent);color:white;padding:12px;border-radius:8px;border:0;font-weight:600;cursor:pointer;width:100%}
  .muted{color:var(--muted);font-size:13px;margin-top:8px}
  .link{color:var(--accent);cursor:pointer;text-decoration:underline}
  .small{font-size:13px;color:var(--muted)}
  .tabs{display:flex;gap:6px;margin-bottom:12px}
  .tab{flex:1;padding:10px;border-radius:8px;text-align:center;cursor:pointer;border:1px solid transparent}
  .tab.active{background:rgba(79,70,229,0.06);border-color:rgba(79,70,229,0.12);font-weight:600;color:var(--accent)}
  .notice{background:#fffbeb;border:1px solid #fde68a;padding:10px;border-radius:8px;margin-top:10px;color:#854d0e;font-size:13px}
  .center{display:flex;justify-content:center}
</style>
</head>
<body>
  <div class="card" role="main">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
      <img src="https://i.imgur.com/7b5YB9a.png" alt="logo" style="width:44px;height:44px;border-radius:8px">
      <div>
        <h1>QuizEarn</h1>
        <p class="lead">Play quizzes, watch ads & earn Diamonds. Secure login with email.</p>
      </div>
    </div>

    <div class="tabs">
      <div id="tab-login" class="tab active" onclick="showTab('login')">Login</div>
      <div id="tab-register" class="tab" onclick="showTab('register')">Register</div>
      <div id="tab-forgot" class="tab" onclick="showTab('forgot')">Forgot</div>
    </div>

    <!-- LOGIN -->
    <div id="panel-login">
      <input id="login-email" placeholder="Email" type="email"/><br><br>
      <input id="login-password" placeholder="Password" type="password"/><br><br>
      <button onclick="doLogin()">Login</button>
      <div class="muted" style="margin-top:10px">Don't have account? <span class="link" onclick="showTab('register')">Create new</span></div>
    </div>

    <!-- REGISTER -->
    <div id="panel-register" style="display:none">
      <input id="reg-name" placeholder="Full name" type="text"/><br><br>
      <input id="reg-email" placeholder="Email" type="email"/><br><br>
      <input id="reg-password" placeholder="Password (min 6 chars)" type="password"/><br><br>
      <input id="reg-cpassword" placeholder="Confirm password" type="password"/><br><br>
      <button onclick="doRegister()">Register</button>
      <div class="muted" style="margin-top:10px">Already have account? <span class="link" onclick="showTab('login')">Login</span></div>
    </div>

    <!-- FORGOT -->
    <div id="panel-forgot" style="display:none">
      <input id="forgot-email" placeholder="Enter your registered email" type="email"/><br><br>
      <button onclick="doForgot()">Send password reset email</button>
      <div class="muted" style="margin-top:10px">Check spam folder if not received.</div>
    </div>

    <div id="msg" class="notice" style="display:none"></div>
    <div style="margin-top:12px" class="center small">By continuing you agree to Terms & Privacy.</div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
/* ---------- PASTE YOUR FIREBASE CONFIG HERE (you already gave) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDmuE4wLWv1ZGfuAUmiRBH1Pz21M3Xs4kc",
  authDomain: "ytify-8982c.firebaseapp.com",
  databaseURL: "https://ytify-8982c-default-rtdb.firebaseio.com",
  projectId: "ytify-8982c",
  storageBucket: "ytify-8982c.firebasestorage.app",
  messagingSenderId: "1072469051926",
  appId: "1:1072469051926:web:45d164d9e150bdf0d1c337",
  measurementId: "G-VFFG8ER5Q2"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
/* ---------------------------------------------------------------------- */

function showMsg(t){
  const el = document.getElementById('msg');
  el.innerText = t;
  el.style.display = 'block';
  setTimeout(()=>{ el.style.display='none'; },8000);
}
function showTab(name){
  document.getElementById('panel-login').style.display = (name==='login')?'block':'none';
  document.getElementById('panel-register').style.display = (name==='register')?'block':'none';
  document.getElementById('panel-forgot').style.display = (name==='forgot')?'block':'none';
  document.getElementById('tab-login').classList.toggle('active', name==='login');
  document.getElementById('tab-register').classList.toggle('active', name==='register');
  document.getElementById('tab-forgot').classList.toggle('active', name==='forgot');
}

/* ----- REGISTER ----- */
async function doRegister(){
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pwd = document.getElementById('reg-password').value;
  const cp = document.getElementById('reg-cpassword').value;
  if(!name || !email || !pwd){ showMsg('Please fill all fields'); return; }
  if(pwd.length < 6){ showMsg('Password must be at least 6 characters'); return; }
  if(pwd !== cp){ showMsg('Password and Confirm Password do not match'); return; }
  try {
    const userCred = await auth.createUserWithEmailAndPassword(email, pwd);
    const user = userCred.user;
    await user.updateProfile({ displayName: name });
    // Send verification email
    await user.sendEmailVerification();
    // Save basic user data to Realtime DB (safe default)
    const usersRef = db.ref('users/' + user.uid);
    const obj = { name: name, email: email, diamonds: 0, createdAt: new Date().toISOString() };
    await usersRef.set(obj);
    showMsg('Registered. Verification email sent. Check spam if not received.');
    // Signal the app (so MIT can capture): set document.title
    document.title = 'LOGIN|' + user.uid + '|' + encodeURIComponent(email) + '|' + encodeURIComponent(name);
  } catch(e) {
    console.error(e);
    showMsg(e.message || 'Register failed');
  }
}

/* ----- LOGIN ----- */
async function doLogin(){
  const email = document.getElementById('login-email').value.trim();
  const pwd = document.getElementById('login-password').value;
  if(!email || !pwd){ showMsg('Please enter email and password'); return; }
  try {
    const userCred = await auth.signInWithEmailAndPassword(email, pwd);
    const user = userCred.user;
    if(!user.emailVerified){
      showMsg('Email not verified. Please check your inbox and spam.');
      return;
    }

    // ensure DB entry exists
    const usersRef = db.ref('users/' + user.uid);
    const snap = await usersRef.once('value');
    if(!snap.exists()){
      await usersRef.set({ name:user.displayName||'', email: user.email, diamonds:0, createdAt: new Date().toISOString() });
    }

    // get user data
    const dataSnap = await usersRef.once('value');
    const data = dataSnap.val() || {};
    const name = data.name || user.displayName || '';
    const diamonds = data.diamonds || 0;

    // ðŸ‘‡ Yeh line add karo
    if(window.AppInventor){
      window.AppInventor.setWebViewString("LOGIN_SUCCESS:" + user.email + ":" + name + ":" + diamonds);
    }

  } catch(e) {
    console.error(e);
    const msg = (e.code === 'auth/wrong-password') ? 'Password wrong' :
                (e.code === 'auth/user-not-found') ? 'Email not registered' :
                e.message || 'Login error';
    showMsg(msg);
  }
}
/* ----- FORGOT PASSWORD ----- */
async function doForgot(){
  const email = document.getElementById('forgot-email').value.trim();
  if(!email){ showMsg('Please enter email'); return; }
  try {
    await auth.sendPasswordResetEmail(email);
    showMsg('Password reset email sent. Check spam folder.');
  } catch(e) {
    console.error(e);
    showMsg(e.message || 'Error sending reset email');
  }
}

/* Optional: on page load check if user is already signed-in */
auth.onAuthStateChanged(async (user) => {
  if(user && user.emailVerified){
    const usersRef = db.ref('users/' + user.uid);
    const snap = await usersRef.once('value');
    const data = snap.val() || {};
    const name = data.name || user.displayName || '';
    const diamonds = data.diamonds || 0;
    document.title = 'LOGIN|' + user.uid + '|' + encodeURIComponent(user.email) + '|' + encodeURIComponent(name) + '|' + diamonds;
  }
});
</script>
</body>
</html>
